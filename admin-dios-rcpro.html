<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PANEL DE DIOS | RC Admin</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- LIBRERÍA SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background: #050505; color: white; font-family: 'Montserrat', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .admin-box { width: 100%; max-width: 500px; padding: 40px; border: 1px solid #333; background: #0a0a0a; box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; }
        h1 { color: #FFD230; text-transform: uppercase; margin-bottom: 30px; text-align: center; font-size: 1.5rem; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        input[type="text"], textarea { width: 100%; padding: 15px; background: #111; border: 1px solid #333; color: white; outline: none; font-family: inherit; box-sizing: border-box; }
        input[type="text"]:focus, textarea:focus { border-color: #0066FC; }
        input[type="file"] { width: 100%; padding: 10px; background: #111; border: 1px solid #333; color: #888; box-sizing: border-box; }
        button { width: 100%; padding: 20px; background: #0066FC; color: white; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; margin-top: 20px; transition: 0.3s; }
        button:hover { background: white; color: black; }
        button:disabled { background: #333; cursor: not-allowed; color: #666; }
        .status { margin-top: 20px; text-align: center; font-size: 0.9rem; color: #FFD230; min-height: 20px; word-wrap: break-word; }
    </style>
</head>
<body>

    <div class="admin-box">
        <h1>PANEL DE DIOS ⚡</h1>
        
        <div class="form-group">
            <label>Título del Recurso</label>
            <input type="text" id="title" placeholder="Ej: Protocolo de Decisión">
        </div>

        <div class="form-group">
            <label>Descripción Corta</label>
            <textarea id="desc" rows="3" placeholder="Breve explicación..."></textarea>
        </div>

        <div class="form-group">
            <label>Archivo PDF (Obligatorio)</label>
            <input type="file" id="pdfFile" accept="application/pdf">
        </div>

        <div class="form-group">
            <label>Imagen Portada (Opcional, jpg/png)</label>
            <input type="file" id="imgFile" accept="image/*">
        </div>

        <button id="btnUpload">PUBLICAR RECURSO</button>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        // 1. CONFIGURACIÓN SUPABASE
        const projectUrl = 'https://ticqgdblrszfcqpnmxsd.supabase.co';
        const projectKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpY3FnZGJscnN6ZmNxcG5teHNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjc5OTcsImV4cCI6MjA4NTgwMzk5N30.T5ihawTnt1FN0nLnIXj_96FO8oE26hxVbPCcf9K-W-o';
        
        // Creamos el cliente con nombre único para evitar conflictos
        const supabaseClient = supabase.createClient(projectUrl, projectKey);

        // 2. EVENT LISTENER
        document.getElementById('btnUpload').addEventListener('click', async () => {
            await uploadResource();
        });

        // 3. FUNCIÓN PRINCIPAL
        async function uploadResource() {
            const status = document.getElementById('status');
            const btn = document.getElementById('btnUpload');
            
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const pdfFile = document.getElementById('pdfFile').files[0];
            const imgFile = document.getElementById('imgFile').files[0];

            if (!title || !desc || !pdfFile) {
                status.innerText = "⚠️ Faltan datos (Título, Descripción o PDF)";
                status.style.color = "#FF5555"; 
                return;
            }

            btn.disabled = true;
            btn.innerText = "SUBIENDO...";
            status.innerText = "Subiendo archivos...";
            status.style.color = "#FFD230";

            try {
                // A. Subir PDF
                // Limpiamos nombre para evitar errores
                const cleanPdfName = pdfFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
                const pdfPath = `pdfs/${Date.now()}_${cleanPdfName}`;
                
                const { error: pdfError } = await supabaseClient.storage
                    .from('materiales')
                    .upload(pdfPath, pdfFile);
                
                if (pdfError) throw new Error("Error subiendo PDF: " + pdfError.message);

                // Obtener URL PDF
                const { data: pdfUrlData } = supabaseClient.storage
                    .from('materiales')
                    .getPublicUrl(pdfPath);
                const pdfUrl = pdfUrlData.publicUrl;

                // B. Subir Imagen (si hay)
                let imgUrl = null;
                if (imgFile) {
                    const cleanImgName = imgFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
                    const imgPath = `covers/${Date.now()}_${cleanImgName}`;
                    
                    const { error: imgError } = await supabaseClient.storage
                        .from('materiales')
                        .upload(imgPath, imgFile);
                    
                    if (imgError) throw new Error("Error subiendo Imagen: " + imgError.message);

                    const { data: imgUrlData } = supabaseClient.storage
                        .from('materiales')
                        .getPublicUrl(imgPath);
                    imgUrl = imgUrlData.publicUrl;
                }

                // C. Guardar en Base de Datos
                const { error: dbError } = await supabaseClient
                    .from('recursos')
                    .insert([{ 
                        titulo: title, 
                        descripcion: desc, 
                        archivo_url: pdfUrl, 
                        imagen_url: imgUrl 
                    }]);

                if (dbError) throw new Error("Error guardando datos: " + dbError.message);

                // ÉXITO
                status.innerText = "✅ ¡PUBLICADO CORRECTAMENTE!";
                status.style.color = "#55FF55";
                btn.innerText = "LISTO";
                
                setTimeout(() => { location.reload(); }, 2000);

            } catch (error) {
                console.error(error);
                status.innerText = "❌ " + error.message;
                status.style.color = "#FF5555";
                btn.disabled = false;
                btn.innerText = "REINTENTAR";
            }
        }
    </script>
</body>
</html>